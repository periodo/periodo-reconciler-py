#!/usr/bin/env python

from periodo_reconciler import (
    RProperty,
    RQuery,
    PeriodoReconciler,
    CsvReconciler, 
    non_none_values
)

import click


@click.command()
@click.argument('input', type=click.File('r'))
@click.argument('output', type=click.File('w'))
@click.option('--query', prompt=True,
                 help='column of query')
@click.option('--start', default=None,
                 help='column of start')
@click.option('--stop', default=None,
                 help='column of stop')
@click.option('--location', default=None,
                 help='column of location')
@click.option('--ignored_queries', default='',
                 help='comma-separated string of queries to ignore')
@click.option('--transpose-query/--no-transpose-query', default=False,
                 help='transpose comma-separated terms in query column')
def reconcile(input, output, query, start, stop, location, ignored_queries, transpose_query):

    p_recon = PeriodoReconciler(host='localhost:8142')

    kw = non_none_values({
        'query': query,
        'start': start,
        'stop': stop,
        'location': location,
        'ignored_queries': ignored_queries,
        'transpose_query': transpose_query
    })

    c_recon = CsvReconciler(input, p_recon, **kw)
    matches = list(c_recon.matches())

    c_recon.to_csv(output, matches)


if __name__ == '__main__':
    reconcile()